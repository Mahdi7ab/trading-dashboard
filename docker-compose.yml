version: "3.8"

services:
  # Ø³Ø±ÙˆÛŒØ³ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ PostgreSQL
  db:
    image: postgres:15-alpine # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ…ÛŒØ¬ Ø±Ø³Ù…ÛŒ Ùˆ Ø³Ø¨Ú© postgres
    container_name: trading_db
    restart: always
    environment:
      - POSTGRES_USER=myuser
      - POSTGRES_PASSWORD=mysecretpassword
      - POSTGRES_DB=trading_db
    volumes:
      - postgres_data:/var/lib/postgresql/data # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§Ø¦Ù…ÛŒ
    ports:
      - "5432:5432" # Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯ØªØ§Ù† (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯)

  # Ø³Ø±ÙˆÛŒØ³ Ú©Ø´Ù ØªØ±ÛŒØ¯Ø±Ù‡Ø§ (Ù‡Ø± 24 Ø³Ø§Ø¹Øª)
  discover_traders:
    build: ./collector # Ù…Ø³ÛŒØ± Ø³Ø§Ø®Øª Ø§ÛŒÙ…ÛŒØ¬ Ø§Ø² Dockerfile
    container_name: trading_discover
    restart: on-failure
    depends_on:
      - db # ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‚Ø¨Ù„ Ø§Ø² Ø¢Ù† Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
    environment:
      # Ù¾Ø§Ø³ Ø¯Ø§Ø¯Ù† Ø¢Ø¯Ø±Ø³ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø±
      - DATABASE_URL=postgresql://myuser:mysecretpassword@db:5432/trading_db
    command: >
      sh -c "
        echo 'Waiting for database...' && sleep 10 &&
        while true; do
          echo 'ğŸš€ Running discover_traders.py (Run every 24h)...';
          python discover_traders.py;
          echo 'âœ… Trader list updated. Waiting 24 hours...';
          sleep 86400; # 86400 Ø«Ø§Ù†ÛŒÙ‡ = 24 Ø³Ø§Ø¹Øª
        done
      "

  # Ø³Ø±ÙˆÛŒØ³ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ (Ù‡Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡)
  collector:
    build: ./collector # Ù…Ø³ÛŒØ± Ø³Ø§Ø®Øª Ø§ÛŒÙ…ÛŒØ¬ Ø§Ø² Dockerfile
    container_name: trading_collector
    restart: on-failure
    depends_on:
      - db # ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‚Ø¨Ù„ Ø§Ø² collector Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
    environment:
      # Ù¾Ø§Ø³ Ø¯Ø§Ø¯Ù† Ø¢Ø¯Ø±Ø³ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø±
      - DATABASE_URL=postgresql://myuser:mysecretpassword@db:5432/trading_db
    command: >
      sh -c "
        echo 'Waiting for database...' && sleep 10 &&
        while true; do
          echo 'ğŸš€ Running collector.py (Run every 10m)...';
          python collector.py;
          echo 'âœ… Fills collected. Waiting 10 minutes...';
          sleep 600; # 600 Ø«Ø§Ù†ÛŒÙ‡ = 10 Ø¯Ù‚ÛŒÙ‚Ù‡
        done
      "

  # Ø³Ø±ÙˆÛŒØ³ ØªØ­Ù„ÛŒÙ„ Ùˆ Ø³Ø§Ø®Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ (Ù‡Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡)
  analyzer:
    build: ./collector
    container_name: trading_analyzer
    restart: on-failure
    depends_on:
      - db
      - collector # Ø§Ø¬Ø±Ø§ Ø¨Ø¹Ø¯ Ø§Ø² collector
    environment:
      # Ù¾Ø§Ø³ Ø¯Ø§Ø¯Ù† Ø¢Ø¯Ø±Ø³ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø±
      - DATABASE_URL=postgresql://myuser:mysecretpassword@db:5432/trading_db
    volumes:
      # Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù¾ÙˆØ´Ù‡ results/ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø´Ù…Ø§ Ø±Ø§ Ø¨Ù‡ Ù¾ÙˆØ´Ù‡ /app/results Ø¯Ø± Ú©Ø§Ù†ØªÛŒÙ†Ø± Ù…ØªØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
      # ./results Ø¨Ù‡ Ù…Ø¹Ù†Ø§ÛŒ Ù¾ÙˆØ´Ù‡â€ŒØ§ÛŒ Ø¨Ù‡ Ù†Ø§Ù… "results" Ø¯Ø± Ù‡Ù…Ø§Ù†Ø¬Ø§ÛŒÛŒ Ø§Ø³Øª Ú©Ù‡ Ø§ÛŒÙ† ÙØ§ÛŒÙ„ docker-compose.yml Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯
      - ./results:/app/results
    command: >
      sh -c "
        echo 'Waiting for database and collector...' &&
        sleep 15 && # Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± Ø§ÙˆÙ„ÛŒÙ‡ ØªØ§ collector Ø§ÙˆÙ„ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
        while true; do
          echo 'ğŸ“Š Running analyzer (query_example.py) (Run every 10m)...';
          python query_example.py;
          echo 'âœ… Analysis complete. Waiting 10 minutes...';
          sleep 600; # 600 Ø«Ø§Ù†ÛŒÙ‡ = 10 Ø¯Ù‚ÛŒÙ‚Ù‡
        done
      "

volumes:
  # ØªØ¹Ø±ÛŒÙ volume Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¯Ø§Ø¦Ù…ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
  postgres_data:
