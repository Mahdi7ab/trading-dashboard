version: "3.8"

services:
  # Ø³Ø±ÙˆÛŒØ³ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ PostgreSQL
  db:
    image: postgres:15-alpine # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ…ÛŒØ¬ Ø±Ø³Ù…ÛŒ Ùˆ Ø³Ø¨Ú© postgres
    container_name: trading_db
    restart: always
    environment:
      - POSTGRES_USER=myuser
      - POSTGRES_PASSWORD=mysecretpassword
      - POSTGRES_DB=trading_db
    volumes:
      - postgres_data:/var/lib/postgresql/data # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§Ø¦Ù…ÛŒ
    ports:
      - "5432:5432" # Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯ØªØ§Ù† (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯)

  # -------------------------------------------------
  # ğŸ”½ (Ø¬Ø¯ÛŒØ¯) Ø³Ø±ÙˆÛŒØ³ Ú©Ø´Ù ØªØ±ÛŒØ¯Ø±Ù‡Ø§ÛŒ Ø¨Ø±ØªØ± ğŸ”½
  # -------------------------------------------------
  discover_traders:
    build: ./collector # Ø§Ø² Ù‡Ù…Ø§Ù† Dockerfile Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    container_name: trading_discover
    restart: on-failure
    depends_on:
      - db # ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‚Ø¨Ù„ Ø§Ø² Ø¢Ù† Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
    environment:
      # Ù¾Ø§Ø³ Ø¯Ø§Ø¯Ù† Ø¢Ø¯Ø±Ø³ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø±
      - DATABASE_URL=postgresql://myuser:mysecretpassword@db:5432/trading_db
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 10 &&
        while true; do
          echo 'ğŸš€ Running discover_traders.py to update top traders...';
          python discover_traders.py;
          echo 'âœ… Trader list updated. Waiting 6 hours for the next run...';
          sleep 21600; # 21600 Ø«Ø§Ù†ÛŒÙ‡ = 6 Ø³Ø§Ø¹Øª
        done
      "

  # -------------------------------------------------
  # ğŸ”½ (ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡) Ø³Ø±ÙˆÛŒØ³ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ú©Ù†Ù†Ø¯Ù‡ Ø¯Ø§Ø¯Ù‡ ğŸ”½
  # -------------------------------------------------
  collector:
    build: ./collector # Ù…Ø³ÛŒØ± Ø³Ø§Ø®Øª Ø§ÛŒÙ…ÛŒØ¬ Ø§Ø² Dockerfile
    container_name: trading_collector
    restart: on-failure
    depends_on:
      - db # ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‚Ø¨Ù„ Ø§Ø² collector Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
    environment:
      # Ù¾Ø§Ø³ Ø¯Ø§Ø¯Ù† Ø¢Ø¯Ø±Ø³ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø±
      - DATABASE_URL=postgresql://myuser:mysecretpassword@db:5432/trading_db
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 10 &&
        while true; do
          echo 'ğŸš€ Running collector.py to fetch fills...';
          python collector.py;
          echo 'âœ… Fills collected. Waiting 10 minutes for the next run...';
          sleep 600; # 600 Ø«Ø§Ù†ÛŒÙ‡ = 10 Ø¯Ù‚ÛŒÙ‚Ù‡
        done
      "

volumes:
  # ØªØ¹Ø±ÛŒÙ volume Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¯Ø§Ø¦Ù…ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
  postgres_data:
