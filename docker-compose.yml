version: "3.8"

services:
  db:
    image: postgres:15-alpine
    container_name: trading_db
    restart: always
    environment:
      - POSTGRES_USER=myuser
      - POSTGRES_PASSWORD=mysecretpassword
      - POSTGRES_DB=trading_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  discover_traders:
    build: ./collector
    container_name: trading_discover
    restart: on-failure
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://myuser:mysecretpassword@db:5432/trading_db
    command: >
      sh -c "
        echo 'Waiting for database...' && sleep 10 &&
        while true; do
          echo 'ðŸš€ Running discover_traders.py (Run every 24h)...';
          python discover_traders.py;
          echo 'âœ… Trader list updated. Waiting 24 hours...';
          sleep 86400; 
        done
      "

  collector:
    build: ./collector
    container_name: trading_collector
    restart: on-failure
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://myuser:mysecretpassword@db:5432/trading_db
    command: >
      sh -c "
        echo 'Waiting for database...' && sleep 10 &&
        while true; do
          echo 'ðŸš€ Running collector.py (Run every 10m)...';
          python collector.py;
          echo 'âœ… Fills collected. Waiting 10 minutes...';
          sleep 600; 
        done
      "

  analyzer:
    build: ./collector
    container_name: trading_analyzer
    restart: on-failure
    depends_on:
      - db
      - collector
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://myuser:mysecretpassword@db:5432/trading_db
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - PROXY_URL=${PROXY_URL}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./results:/app/results
    command: >
      sh -c "
        echo 'Waiting for database and collector...' &&
        sleep 15 && 
        while true; do
          # -------------------------------------------------
          # ðŸ”½ (ØªØºÛŒÛŒØ±) Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¬Ø¯ÛŒØ¯ ðŸ”½
          # -------------------------------------------------
          echo 'ðŸ“Š Running analyzer (analyzer.py)...';
          python analyzer.py; 
          echo 'âœ… Analysis and sending complete. Waiting 10 minutes...';
          sleep 600; 
        done
      "

volumes:
  postgres_data:
